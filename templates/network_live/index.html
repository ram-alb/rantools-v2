{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1 class="card-title text-center">Select technologies</h1>
    <div class="row justify-content-center">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <form method="POST" id="network_live">
                        {% csrf_token %}
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="lte" id="lte">
                                <label class="form-check-label" for="lte">
                                    LTE Cells
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="wcdma" id="wcdma">
                                <label class="form-check-label" for="wcdma">
                                    WCDMA Cells
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="gsm" id="gsm">
                                <label class="form-check-label" for="gsm">
                                    GSM Cells
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="nr" id="nr">
                                <label class="form-check-label" for="nr">
                                    NR Cells
                                </label>
                            </div>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-primary" id="nl-submit">Download</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const nlForm = document.getElementById('network_live');

    nlForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const submitBtn = document.getElementById('nl-submit');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>Loading...';

        const formData = new FormData();
        checkboxes = document.querySelectorAll('.form-check-input:checked');
        const technologiesArray = Array.from(checkboxes).map(checkbox => checkbox.value);
        const sortedTechnologies = technologiesArray.sort(); // Sort alphabetically
        sortedTechnologies.forEach(technology => {
            formData.append('technologies[]', technology);
        });
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('{% url "network_live" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.blob())
        .then(data => {
            const url = window.URL.createObjectURL(data);
            const anchor = document.createElement("a");
            anchor.href = url;
            // Dynamically set the filename based on selected technologies
            const selectedTechnologies = sortedTechnologies.join('_');
            anchor.download = 'kcell_' + selectedTechnologies + '_data.xlsx';
            anchor.click();

            submitBtn.innerHTML = 'Download';
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            })
        });
    });

</script>
{% endblock %}
